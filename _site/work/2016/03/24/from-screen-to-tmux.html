<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
    <head>
        <meta charset="utf-8">
        <meta property="wb:webmaster" content="f97b0cc1aaecb801" />

        <!-- 百度站内搜索 -->
        <meta name="baidu-site-verification" content="VYH77GDc5e" />
        <!-- 百度站内搜索 -->

        <title>放弃screen,拥抱tmux</title>
        <!--<meta name="viewport" content="width=device-width, initial-scale=1" />-->
        <!--<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />-->

        <link rel="stylesheet" href="/css/highlight7.1.default.min.css">
        <script src="/js/highlight7.1.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <link rel="stylesheet" href="/css/style.css">

        <!--
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-49284793-2', 'yanyiwu.com');
          ga('send', 'pageview');

        </script>
        -->

        <!-- picture -->
        <!--
        <script type="text/javascript" src="/js/pic.js"> </script>
        -->

        <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>

    </head>
    <body>
        <nav>
            <ul>
                <li onclick="location.href='/'">首页</li>
                <li onclick="location.href='/moment.html'">时间线</li>
                <li onclick="location.href='#'">发现</li>
                <li onclick="location.href='/about.html'">关于</li>
            </ul>
        </nav> 
        <div class="blog_index">
            <div id="logo">

            </div>
            <div>
                <div>
<h1 class="post_title">
    放弃screen,拥抱tmux
</h1>

<div class="post_date">
    24 Mar 2016
</div>

<div class="blog_post">
    <p><center><br>
<img src="http://7viirv.com1.z0.glb.clouddn.com/firehazard.jpg" class="photo"></img><br>
</center>        </p>

<p>『故事背景』  </p>

<p>screen/tmux 是远程ssh session的管理工具。<br>
可以在server端帮你保存工作现场和恢复工作现场。<br>
最典型的应用场景就是，你每天下班关机器的时候，先保存现场(session)。<br>
然后第二天上班的时候再登录上去恢复现场(session) ，可以一下子就进入到之前的工作状态，<br>
比如当时正使用vim编写代码编写到第N行的状态。  </p>

<p>说起screen我是感情很深厚的，从我第一份实习去阿里云开始。<br>
刚入职的第一天学长（北邮亲学长，对我帮助很大，也算是我生命中遇到的贵人之一）<br>
传授给我一份screen配置，然后叫我开始养成使用screen在服务器上面开发的习惯。<br>
screen的配置文件我现在仍然沿用（在一些没有tmux的环境下），在我的<a href="https://github.conf/yanyiwu">GitHub</a>上面的代码 <a href="https://github.com/yanyiwu/etc/blob/master/linux/.screenrc">screenrc</a> 。<br>
受益良多。  </p>

<p>直到有一天在另一家公司听到同事推荐tmux更强大，<br>
刚好我又遇到在某台机器上面使用screen死活中文编码有问题的情况。<br>
就直接切换到tmux了，从screen切换到tmux几乎没有任何学习成本。<br>
同样也仿照 <a href="https://github.com/yanyiwu/etc/blob/master/linux/.screenrc">screenrc</a> 配置文件的写法，配置了一下 <a href="https://github.com/yanyiwu/etc/blob/master/linux/.tmux.conf">tmuxconf</a> 。<br>
然后就用得飞起了，同时也解决了中文编码显示的问题。<br>
沿用至今。  </p>

<p>『东窗事发』  </p>

<p>最近刚好一直在做上线前的联调测试各种跑测试。<br>
然后同事发现自己那部分的server在测试的时候会莫名其妙的hang住了。<br>
以前没有遇到过的，以为是新增加的逻辑导致的死锁之类的故障。<br>
后来发现是screen的锅。</p>

<p>『Bug复现』  </p>

<p>同事使用的就是在 screen 里面启动的服务，输出的日志没有重定向到文件。<br>
一些最简化的复现场景如下：<br>
比如ssh到远程的服务器上，在screen某一个窗口下运行如下的shell脚本  </p>
<div class="highlight"><pre><code class="language-" data-lang="">while (true)  
do  
    echo "github.com/yanyiwu"  
done  
</code></pre></div>
<p>然后把本地机器的网线拔掉。<br>
然后等连接都断开之后，再把网线插上，再登录上去。<br>
会发现当时那个 screen session 的状态还是 Attached ，而不是正常的 Detached .<br>
然后再试图通过如下命令  </p>
<div class="highlight"><pre><code class="language-" data-lang="">screen -d -r &lt;session-name&gt;  
</code></pre></div>
<p>已经无法重新恢复session了。<br>
在我们的测试中也就是表现为那个服务无法正常接收请求了。  </p>

<p>但是如果是在 tmux 中做同样的事情的话。<br>
就不会有hang住的问题，一切正常运行。<br>
也就不会出现最开始以为是服务代码问题的恐慌了。  </p>

<p>『最后』  </p>

<p>好吧有点标题党了，其实tmux还有其他一些不错的功能比screen好的。<br>
毕竟tmux是screen的增强版。<br>
虽然本文其实就是一次screen踩坑记录而已。<br>
但是我觉得还是有必要宣传一下tmux的，所以就把标题起得比较浮夸了。  </p>

<p>『题图』</p>

<p>还有就是配图是今天，准确的来说应该是昨天：
2016年3月23日，中关村南大街寰太大厦二楼一家饭店着火的图。<br>
当时我刚好就在15楼上班。<br>
狂奔下楼，所幸无任何人员伤亡。  </p>

<center>
<img src="http://7viirv.com1.z0.glb.clouddn.com/qrcodes_yanyiwu_public.jpg" class="photo" style="width:60%"></img>
</center>
<!--<p>转载请注明出处: <a href="/work/2016/03/24/from-screen-to-tmux.html">放弃screen,拥抱tmux</a></p>!-->
</div>

</div>

<div class="review">

<!-- 百度分享按钮 start -->
<!--
<div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"24"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
-->
<!-- 百度分享按钮 end -->


<!-- 微博分享按钮 start -->
<!--
<wb:share-button addition="simple" type="button" ralateUid="1644441707"></wb:share-button>
-->

<!-- 多说评论框 start
<div class="ds-thread" data-thread-key="/work/2016/03/24/from-screen-to-tmux" data-title="放弃screen,拥抱tmux" data-url="yanyiwu.com/work/2016/03/24/from-screen-to-tmux.html">
</div>
<!-- 多说评论框 end 
<!-- 多说公共JS代码 start (一个网页只需插入一次)
<script type="text/javascript">
var duoshuoQuery = {short_name:"yanyiwu"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->


</div>

            </div>
        </div>
        
        <footer id="footer">
            <p>
                <!--<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253065108'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253065108' type='text/javascript'%3E%3C/script%3E"));</script> -->
                
            </p>
        </footer>
    </body>
</html>
